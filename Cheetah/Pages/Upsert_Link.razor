@page "/Links/Create/{Name}/{type}/{LinkId:long}/{reference}"
@page "/Links/Edit/{Name}/{type}/{Id:long}/{reference}"
@using System.Web;
@using System.Runtime.Serialization.Formatters.Binary;
@using System.Text;

@inject ISimpleClassRepository simpleClassRepository;
@inject NavigationManager _NavigationManager;
@inject CNavigation _CNavigation;
<NavigationComponent _CNavigation="@_CNavigation" />
@if (!IsLoading)
{
    <CEditLinks Record="@Record" type="@type" LinkId="@LinkId"
            Id="@Id" Name="@Name" Title="@Title" IsLoading="@IsLoading"
            reference="@reference">
        <RowTemplate>

            <CInput @bind-LValue="Record.FirstId" Records="@d_Users"
                CDescription="کاربر" Disabled="@(type == SD.First)"
                CDisplayName="کاربر" CFieldType="@(FieldType.CSelect)"></CInput>

            <CInput @bind-LValue="Record.SecondId" Records="@d_Areas"
                CDescription="واحد" Disabled="@(type == SD.Second)"
                CDisplayName="واحد" CFieldType="@(FieldType.CSelect)"></CInput>
        </RowTemplate>
    </CEditLinks>
}

@code {
    [Parameter]
    public long? Id { get; set; }

    [Parameter]
    public long LinkId { get; set; } = 0;

    [Parameter]
    public String? Name { get; set; }

    [Parameter]
    public String? reference { get; set; }

    [Parameter]
    public String type { get; set; }


    public SimpleLinkClass Record { get; set; }

    public IEnumerable<SimpleClass> d_Users { get; set; }

    public IEnumerable<SimpleClass> d_Areas { get; set; }

    private String Title { get; set; }

    public Boolean IsLoading { get; set; } = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDTO();
        }
        if (reference is null || firstRender)
        {
            reference = _CNavigation.LoadNavigation(Address: $"Links/{((Id > 0) ? "Edit" : "Create")}/{Name}/{type}/{((Id > 0) ? Id : LinkId)}",
            RowDescription: Record.PDisplayName, RowId: Record.Id, Reference: reference);

            IsLoading = false;
            StateHasChanged();
        }
    }
    private async Task LoadDTO()
    {
        Record = await simpleClassRepository.Get(Name, Id) as SimpleLinkClass;

        if (type == SD.First)
        {
            if (Record.FirstId == 0)
                Record.FirstId = LinkId;
            else
                LinkId = Record.FirstId;
        }
        else
        {
            if (Record.SecondId == 0)
                Record.SecondId = LinkId;
            else
                LinkId = Record.SecondId;
        }

        d_Areas = await simpleClassRepository.GetAllByName("D_Area");
        d_Users = await simpleClassRepository.GetAllByName("D_User");
        Title = Record.Id > 0 ? "ویرایش" : "ایجاد";
    }
}